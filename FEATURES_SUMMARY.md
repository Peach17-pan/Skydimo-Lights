# 功能实现总结

## 项目概述

本项目实现了一个基于规则的智能灯光控制系统，能够根据电脑当前状态（应用类别、时间、硬件使用率、用户活动等）自动决定灯光模式。

---

## 一、系统状态监控功能

### 1.1 前台应用监控
- **功能**：周期性获取当前前台窗口信息
- **采集内容**：
  - 进程名称
  - 窗口标题
  - 进程ID
  - 可执行文件路径
  - 是否接近全屏（95%以上）
- **采集频率**：默认3秒（可自定义）

### 1.2 应用分类
- **功能**：自动识别应用类别
- **支持类别**：
  - 游戏类（GAME）
  - 电影/视频类（VIDEO）
  - 音乐类（MUSIC）
  - 文档/办公类（DOCUMENT）
  - 浏览器/上网类（BROWSER）
  - 开发/编程类（DEVELOPMENT）
  - 创作类（CREATIVE）
  - 未知（UNKNOWN）
- **分类方式**：
  - 进程名精确匹配（支持配置文件）
  - 关键词匹配（进程名和窗口标题）

### 1.3 时间信息
- **当前时间**：显示小时:分钟（如 `14:30`）
- **星期几**：显示周一~周日
- **时间戳**：完整的时间戳（年月日 时分秒.毫秒）

### 1.4 CPU使用率监控
- **功能**：实时监控整体CPU使用率
- **范围**：0-100%
- **精度**：保留1位小数
- **实现方式**：使用Windows `GetSystemTimes` API

### 1.5 用户空闲时间（Idle时间）
- **功能**：检测从上次键盘/鼠标操作起的空闲时间
- **单位**：分钟
- **精度**：保留1位小数
- **实现方式**：使用Windows `GetLastInputInfo` API

### 1.6 音频活动检测
- **功能**：检测系统是否有明显音频输出
- **返回值**：有/无
- **实现方式**：使用Windows WASAPI检测音频峰值
- **阈值**：1%（可调整）
- **缓存机制**：每500ms检测一次，避免频繁检测

---

## 二、规则引擎系统

### 2.1 规则结构
- **条件**：支持多个条件组合（AND逻辑）
- **目标模式**：满足条件时触发的灯光模式
- **优先级**：数值越大优先级越高

### 2.2 支持的条件类型

#### 2.2.1 应用类别条件
- 根据当前前台应用的类别进行判断
- 支持所有应用类别（游戏、视频、音乐、办公等）

#### 2.2.2 时间段条件
- 支持指定时间段（如 23:00-07:00）
- 支持跨天时间段
- **工作日/周末区分**：
  - `WeekdayType::ANY` - 任意（工作日和周末都匹配）
  - `WeekdayType::WEEKDAY` - 仅工作日（周一～周五）
  - `WeekdayType::WEEKEND` - 仅周末（周六、周日）

#### 2.2.3 CPU使用率阈值条件
- 支持大于或小于等于阈值
- 示例：CPU使用率 > 80%

#### 2.2.4 Idle时间阈值条件
- 支持大于等于或小于阈值
- 示例：空闲时间 ≥ 10分钟

#### 2.2.5 音频活动条件
- 检测是否有音频输出
- 支持有/无两种状态

### 2.3 灯光模式

系统支持以下7种灯光模式：

| 模式 | 枚举值 | 说明 |
|------|--------|------|
| 游戏/屏幕同步 | `GAME_SCREENSYNC` | 游戏时使用，与屏幕内容同步 |
| 影视模式 | `VIDEO_CINEMATIC` | 观看视频时使用 |
| 音乐律动 | `MUSIC` | 听音乐时使用，随音乐律动 |
| 办公/写代码 | `WORK_CODING` | 办公或编程时使用，静态模式 |
| 夜间弱光 | `NIGHT_DIM` | 夜间使用，降低亮度 |
| 关闭灯光 | `OFF` | 关闭所有灯光 |
| 默认模式 | `DEFAULT` | 默认模式，无规则匹配时使用 |

### 2.4 优先级机制

当多个规则同时满足时，系统按优先级从高到低选择：
- **优先级数值越大，优先级越高**
- 第一个所有条件都满足的规则会被采用

### 2.5 预配置规则

当前系统预配置了11条规则：

| 优先级 | 条件 | 灯光模式 |
|--------|------|----------|
| 10 | 23:00-07:00（任意） | 夜间弱光 |
| 9 | 空闲 ≥ 10分钟 | 关闭灯光 |
| 8 | 游戏类应用 | 游戏/屏幕同步 |
| 7 | 视频类应用 | 影视模式 |
| 6 | 音乐类应用 | 音乐律动 |
| 5 | 开发/编程类应用 | 办公/写代码 |
| 4 | 文档/办公类应用 | 办公/写代码 |
| 3 | CPU使用率 > 80% | 游戏/屏幕同步 |
| 2 | 有音频活动（非游戏场景） | 音乐律动 |
| 1 | 工作日 09:00-18:00 | 办公/写代码 |
| 0 | 周末 09:00-18:00 | 音乐律动 |

---

## 三、配置化功能

### 3.1 应用分类配置化
- **配置文件**：`app_category_config.txt`
- **格式**：`进程名=类别名`
- **支持注释**：以 `#` 开头的行
- **命令行参数**：`--config` 或 `-c` 指定配置文件路径
- **后备方案**：如果配置文件不存在，使用默认硬编码映射

### 3.2 规则配置
- **当前方式**：代码中硬编码（`main.cpp` 的 `InitializeRules()` 函数）
- **未来扩展**：可支持从配置文件加载

---

## 四、对外接口

### 4.1 函数接口
- **接口函数**：`RuleEngine::DecideLightMode(const SystemState& state)`
- **使用方式**：上层定期调用获取当前判定的灯光模式
- **返回值**：`LightMode` 枚举值

### 4.2 模式变化检测
- Demo程序自动检测灯光模式变化
- 模式变化时输出：`>>> Mode changed to: XXX (from YYY)`

---

## 五、Demo程序功能

### 5.1 周期性输出
程序每3秒（可自定义）输出一次完整状态信息：

```
[2024-01-15 14:30:25.123]
  应用类别: 开发/编程类
  当前时间: 14:30 (周一)
  CPU使用率: 45.2%
  Idle时间: 0.5 分钟
  音频活动: 有
  当前判定的灯光模式: 办公/写代码
------------------------------------------------------------
```

### 5.2 模式变化提示
当灯光模式发生变化时，清晰输出：
```
>>> Mode changed to: 游戏/屏幕同步 (from 办公/写代码)
```

### 5.3 命令行参数
- **监控间隔**：`app_state_monitor.exe <间隔毫秒数>`
  - 示例：`app_state_monitor.exe 1000` （每1秒）
- **调试模式**：`--debug` 或 `-d`
- **配置文件**：`--config <文件路径>` 或 `-c <文件路径>`

---

## 六、技术实现

### 6.1 核心模块

| 模块 | 文件 | 功能 |
|------|------|------|
| 窗口监控 | `window_monitor.h/cpp` | 获取前台窗口信息 |
| 应用分类 | `app_classifier.h/cpp` | 应用类别识别 |
| 规则引擎 | `rule_engine.h/cpp` | 规则管理和决策 |
| 音频监控 | `audio_monitor.h/cpp` | 音频活动检测 |
| 主程序 | `main.cpp` | Demo程序和规则初始化 |

### 6.2 Windows API使用
- `GetForegroundWindow()` - 获取前台窗口
- `GetSystemTimes()` - 获取CPU使用率
- `GetLastInputInfo()` - 获取用户空闲时间
- `WASAPI (IAudioMeterInformation)` - 检测音频活动
- `QueryFullProcessImageName()` - 获取进程路径

### 6.3 编译配置
- **C++标准**：C++17
- **构建系统**：CMake
- **编译器**：MSVC / GCC / Clang
- **输出目录**：`build/bin/Release/`

---

## 七、文档

### 7.1 主要文档
- `RULE_ENGINE_README.md` - 规则引擎系统说明
- `RULE_ENGINE_TEST.md` - 规则引擎验证指南
- `APP_CATEGORY_CONFIG_README.md` - 应用分类配置说明
- `README_CPP.md` - C++项目说明
- `BUILD.md` - 编译说明

### 7.2 配置文件
- `app_category_config.txt` - 应用分类配置文件（示例）

---

## 八、特性总结

### 8.1 已实现特性
✅ 周期性系统状态监控（应用、时间、CPU、空闲时间）  
✅ 应用自动分类（8种类别）  
✅ 规则引擎系统（5种条件类型，7种灯光模式）  
✅ 优先级机制（多规则冲突处理）  
✅ 工作日/周末时间规则  
✅ 音频活动检测  
✅ 应用分类配置化  
✅ 模式变化检测和提示  
✅ 完整的Demo程序  
✅ 详细的文档说明  

### 8.2 技术特点
- **高内聚、低耦合**：模块化设计，职责清晰
- **可扩展**：易于添加新条件类型和灯光模式
- **可配置**：应用分类支持配置文件
- **可预测**：优先级机制保证结果稳定
- **跨平台准备**：核心逻辑与Windows API分离

### 8.3 代码质量
- 遵循SOLID、DRY、SRP原则
- 清晰的代码注释
- 错误处理机制
- 资源管理（RAII）

---

## 九、使用示例

### 9.1 基本使用
```powershell
# 使用默认配置（3秒间隔）
.\build\bin\Release\app_state_monitor.exe

# 自定义间隔（1秒）
.\build\bin\Release\app_state_monitor.exe 1000

# 启用调试模式
.\build\bin\Release\app_state_monitor.exe --debug

# 指定应用分类配置文件
.\build\bin\Release\app_state_monitor.exe --config my_config.txt
```

### 9.2 添加新应用分类
编辑 `app_category_config.txt`：
```
myapp.exe=GAME
```

### 9.3 添加新规则
修改 `main.cpp` 的 `InitializeRules()` 函数，添加新规则。

---

## 十、未来扩展方向

1. **规则配置化**：从JSON/YAML文件加载规则
2. **动态规则管理**：运行时添加/删除规则
3. **图形界面**：提供GUI进行规则配置
4. **更多条件类型**：网络活动、特定进程等
5. **规则组合**：支持OR逻辑、NOT逻辑
6. **规则导入/导出**：规则配置的备份和分享

---

## 总结

本项目实现了一个完整的智能灯光控制系统，包括：
- **状态监控**：应用、时间、CPU、空闲、音频
- **规则引擎**：灵活的条件组合和优先级机制
- **配置化**：应用分类可配置
- **Demo程序**：完整的使用示例和输出

系统设计遵循良好的软件工程原则，代码结构清晰，易于维护和扩展。


